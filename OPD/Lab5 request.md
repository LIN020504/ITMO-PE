# Лабораторная работа No5. 
# Асинхронный обмен данными с ВУ
>实验室工作No5
>与 VU 进行异步数据交换
## Цель работы 实验目的
изучение организации системы ввода-вывода базовой ЭВМ, команд ввода-вывода и исследование процесса функционирования ЭВМ при обмене данными по сигналам готовности внешних устройств (ВУ).
> 研究基础计算机的输入输出系统的组织结构、输入输出命令，以及研究根据外部设备 (ED) 的就绪信号交换数据时计算机的运行过程
## Задание 任务
По выданному преподавателем варианту разработать программу асинхронного обмена данными с внешним устройством. При помощи программы осуществить ввод или вывод информации, используя в качестве подтверждения данных сигнал (кнопку) готовности ВУ
> 根据老师给出的版本，开发一个与外部设备进行异步数据交换的程序。在程序的帮助下，输入或输出信息，使用 VU 准备就绪的信号（按钮）作为数据的确认
## Подготовка к выполнению работы. 工作准备
Изучить организацию системы ввода-вывода и команды ввода-вывода базовой ЭВМ, организацию асинхронного программно-управляемого обмена данными (Приложение В, п.п.2.1-2.3, пример 3). Разработать заданную программу и составить ее описание. Команды программы, используемые переменные и коды символов необходимо разместить в указанных ячейках. Закодировать строку в заданной кодировке, а также в кодировках UTF-8 и UTF-16.
> 研究输入输出系统的组织和基础计算机的输入输出命令，异步程序控制数据交换的组织（附录 B，第 2.1-2.3 段，示例 3）。开发一个给定的程序并写下它的描述。程序命令、使用的变量和字符代码必须放在指定的单元格中。以指定的编码以及 UTF-8 和 UTF-16 编码对字符串进行编码。
## Порялок вьшолнення работы 工作步骤
1. Получить допуск к лабораторной работе, предъявив преподавателю подготовленные материалы.
   通过向老师展示准备好的材料来获得实验室工作的机会
2. Разработать и занести в БЭВМ программу, при необходимости ввести данные.
   开发程序并输入计算机，必要时输入数据。
3. Предъявить преподавателю заданную работающую программу, выполняющую в автоматическом режиме ввод-вывод символов.
   向教师展示一个给定的执行字符自动输入输出的工作程序。
4. В режиме покомандного выполнения программы ввести (вывести) два первых символов заданного слова, заполняя таблицу трассировки.
   在程序的逐命令执行模式下，输入（输出）给定单词的前两个字符，填写跟踪表。
5. Перевести ЭВМ в режим автоматического выполнения программы и ввести (вывести) остальные символы заданного слова. Таблицу трассировки подписать у преподавателя!
   将计算机切换到程序自动执行模式，输入（输出）给定单词的剩余字符。跟老师签下轨迹表！
6. Опционально, по дополнительному заданию преподавателя, переделать устройство ввода-вывода (ВУ-1...ВУ-3) на ВУ-4...ВУ-10.
   可选地，根据老师的附加任务，将输入输出设备（VU-1 ... VU-3）转换为VU-4 ... VU-10。
## Содержание отчета по работе. 报告内容
Отчет по работе должен быть составлен аналогично лабораторной работе No2, за исключением п. 4 (разработка программы с сокращенным числом команд). Кроме того, отчет должен содержать заданное слово и коды его символов и текст исходной программы на языке Ассемблера БЭВМ. (синтаксис и особенности приведены в Приложении Д).
> 除第 4 段（开发减少命令数量的程序）外，工作报告的编写应与实验室工作 No2 类似。此外，报告必须包含给定的单词和其字符的代码以及计算机汇编语言的源程序文本。 （语法和特性在附录 D 中给出）。
## Контрольные вопросы: 答辩问题
1. Синхронный и асинхронный режимы передачи данных.
2. Программно-управляемый и управляемый прерываниями ввод-вывод, прямой доступ к памяти. Преимущества и недостатки.
3. Способы и формат представления символьных и строковых данных в БЭВМ. Кодировки ASCII, КОИ-8, Windows-1251, ISO-8859-5, UTF-8, UTF-16.
4. Порядок байтов в памяти от младшего к старшему (little-endian) и от старшего к младшему (big-endian).
5. Система команд ввода-вывода БЭВМ. Команды in, out, - название, назначение и тип команды. Количество и название машинных циклов, потактовое выполнение команды, с перечислением всех шин, участвующих в обмене.
6. Какие режимы передачи данных и управления вводом-выводом реализуемы в БЭВМ? Почему не возможно реализовать другие?
7. Может ли ВУ определить в каком режиме с ним работают?
8. Назначение флага готовности В/ регистра данных ВУ (DR DEV), регистра
состояния ВУ (CR DEV)?
9. Какие элементы БЭВМ участвуют в обмене с ВУ? Укажите направление
передачи данных между элементами при операциях ввода и вывода.

# Приложение В. Состав, структура и функционирование БЭВМ-NG 
## Часть 2. Организация ввода-вывода в базовой ЭВМ
> 附录 C. BEVM-NG 的组成、结构和功能
第 2 部分。基础计算机中输入输出的组织

Обмен информацией с внешним устройством состоит из инициации обмена. где осуществляются предварительные действия по подготовке к вводу или выводу данных (установка соединения, ожидание готовности и пр.) и собственно обмена банными (их передачей или приемом).  
与外部设备的信息交换包括交换的启动。为准备数据的输入或输出（建立连接、等待就绪等）和数据的实际交换（它们的传输或接收）进行初步操作

Если и инициацией и обменом занимается центральный процессор, то такой обмен называется проераммно-управляеммм. Программно-управляемый обмен по способу инициации разделяется на синхроннМ. когда обмен начинается в заранее известный промежуток времени (например, каждую минуту) и асинхроннМ. когда программе неизвестно время начала обмена данными и она вынуждена периодически проверять возможность обмена (например, готовность внешнего устройства).  
如果启动和交换都由中央处理器处理，则这种交换称为程序控制。软件控制的交换按启动的方法分为同步的。当交换以预定的时间间隔（例如，每分钟）开始时，是异步的。当程序不知道数据交换的开始时间，它被迫定期检查交换的可能性（例如，外部设备的准备情况）

Чтобы исключить периодическую проверку готовности, устройства могут сами инициировать обмен по специальному аппаратному сигналу, который называется запрос прерывания, а соответствующий обмен — управляемый прерываниями ввод- вывод. При таком способе внешнее устройство сигнализирует процессору о необходимости начать обмен, процессор приостанавливает (прерывает) текущую программу, осуществляет ввод-вывод с помощью npozpaMMVi обработки прерывания, а затем продолжает выполнять основную программу.  
为了消除周期性的就绪检查，设备可以自己发起一个特殊的硬件信号交换，称为中断请求，相应的交换是中断驱动的 I/O。使用这种方法，外部设备向处理器发出信号以开始交换，处理器暂停（中断）当前程序，使用 npozpaMMVi 中断处理程序执行 I/O，然后继续执行主程序
 
ВбоЗ-бМбо。с использованием прямого доступа к (ПДП, в английской литературе DMA) организует и инициацию и обмен данными при помощи контроллеров ПДП. Такие контроллеры передают данные непосредственно в память ЭВМ, при этом центральный процессор в обмене данными не участвует.  
VboZ-bMbo。使用直接访问（DMA，英文文献中的DMA）使用DMA控制器组织初始化和数据交换。这种控制器直接将数据传输到计算机内存，而中央处理器不参与数据交换

Обмен данными (прием и передача) может также быть организован синхронно. когда наличие данных на шине подтверждается специальным сигналом синхронизации с постоянной частотой, и асинхронно, с использованием сигналов готовности и/или подтверждения приема-передачи данных.  
数据交换（接收和传输）也可以同步组织。当总线上的数据存在通过具有恒定频率的特殊同步信号来确认时，并且异步地，使用就绪信号和/或数据传输和接收的确认

Задачу инициации и обмена данными в ЭВМ осуществляют специальные программы (такие программы еще называют драйверами), которые совместно с аппаратурой ЭВМ организуют и контролируют процесс ввода-вывода.
计算机中启动和交换数据的任务是由特殊程序（此类程序也称为驱动程序）执行的，这些程序与计算机硬件一起组织和控制输入输出过程

### 2.1 Устройства ввода-вывода базовой ЭВМ

Модель базовой ЭВМ с контроллерами устройств ввода-вывода представлена на рис В.11. В базовой ЭВМ используются простейшие внешние устройства (ВУ): устройство вывода (ВУ-1), устройства ввода ВУ-2 и устройство ввода-вывода ВУ-3. В модели устройства ввода-вывода представлены 8-разрядными регистрами данных (РД ВУ). Через регистры данных ВУ-2 и ВУ-3 информация может быть введена в базовую ЭВМ, а в регистры данных ВУ-1 и ВУ-3 принята из базовой ЭВМ.

Кроме того, в последней версии БЭВМ реализован таймер (устройство ВУ-0), которое вызывает прерывание через заданное в его DR число секунд; устройство ввода-вывода ВУ-4, аналогичное с ВУ-3, за исключением того, что используются отдельные регистры для входных и выходных данных; текстовый принтер ВУ-5; бегущая строка ВУ-6; 8-ми разрядный 7-сегментный индикатор ВУ-7; клавиатура ВУ- 8 и цифровая клавиатура ВУ-9.

Между ВУ и процессором включены простейшие контроллеры внешнего устройства (КВУ), каждый из которых содержит:

- дешифратор адреса, позволяющий выделить обращение к данному ВУ среди всех обращений к устройствам ввода-вывода, подключенных к процессору;
- логику управления КВУ. набор логических схем, позволяющий реагировать и формировать сигналы шины БЭВМ. Данные схемы не представлены подробно для КВУ-3, в качестве примера реализации необходимо обратится к схеме КВУ-1 на рис. В.11;
- регистр данных (DR - Data Register), через который происходит обмен данными между процессором и внешним устройством;
- регистр состояния (SR - State Register), в котором хранится информация о готовности ВУ к обмену данными с процессором. В контроллерах простейших ВУ используются однобитовые регистры готовности, которые часто называют флагом.
- регистр управления (MR - Management Register), регистр, в котором используются 4 младших разряда, разряд 3 - для разрешения прерывания от контроллера и разряды с 0 по 2, которые содержат номер вектора прерывания. Если прерывания разрешены командой ei и установлено разрешение прерывания от контроллера (разряд 3), то контроллер будет генерировать сигнал IntRq и выставлять номер вектора прерывания на шину адреса.

Контроллеры ВУ связаны с процессором при помощи системной шины БЭВМ, в сегменты (или, физически, разъемы для установки контроллеров) которой подсоединяются различные шины со стороны процессора и контроллера:

- шина данных (Data0..7), по которым происходит передача данных в процессор или из процессора;
- шина адреса (Addr0..7), по которой передается адрес внешнего устройства от процессора к КВУ и номер вектора запроса на прерывание (Int#) от КВУ к процессору, подтверждаемый сигналом выдачи вектора (IntV);
- сигнал запроса прерывания (IntRq), по которому выставляется требование прерывания от внешнего устройства;
- сигнал ввода (Input) - для передачи приказа на ввод (in #reg);
- сигнал вывода (Output) - для передачи приказа на вывод (out #reg);
- начальный сигнал предоставления прерывания (IntSC), который управляется
программно микрокодом в цикле прерывания по микрокоманде ints.
- входящий цепочный сигнал предоставления прерывания (IntSCi# - Interrupt Supply Chain input), по которому контоллер, в соответствии с порядком подключения к шине, проверяет возможность предоставления ему прерывания
в соответствии с очередью подключения, и генерирует прерывание, если они
разрешены глобально командой ei ив регистре MR контроллера;
- исходящий цепочный сигнал предоставления прерывания (IntSCo# - Interrupt Supply Chain output), который передает контроллер по шине далее следующему КВУ, если нет необходимости вызвать прерывание
вычислительного процесса;
- сигнал готовности (Rdy), подтверждающий завершение операции ввода- вывода внутри цикла обмена между АС и DR соответствующего КВУ. В случае операции ввода Rdy подтверждает данные, передаваемы по шине данных, и в обоих случаях операции ввода-вывода сигнализирует о том, что цикл обмена с регистром данных DR контроллера завершен;
- сигнал синхронизации (Зул) от тактового генератора БЭВМ, который задает временной слот единичного обмена по шине БЭВМ.

Со стороны процессора к системной шине БЭВМ подключены:
- дешифратор приказа (DC 10), который преобразует приказ в КОП команды ввода-вывода в набор управляющих сигналов на шине. 0-й выход дешифратора активен после команды DI; 1 - для ei; 2 - для команды in, формируя на шине БЭВМ сигнал Input; 3 — для команды оит и сигнала Output.
Выходы, начиная с 4-го не используются;
- регистр разрешения прерывания, который входит в состав PS 5-ым разрядом, и показывает глобальный статус разрешений прерывания в процессоре;
- регистр прерывания от КВУ. по которому выполняется цикл прерывания, если прерывания разрешены глобально и в настоящее время на шине БЭВМ есть запрос на прерывание от одного из КВУ. Данный регистр входит в состав PS в 6-ым разрядом;
- логика управления шины БЭВМ предназначена для подключения и отключения приемо-передатчиков сигналов КВУ и процессора для осуществления обмена CPU с одним из контроллеров в один момент времени.

Назначение регистров контроллеров внешних устройств представлены в
таблице В.12. R - означает, что регистр доступен только для чтения, W - только для записи. R/W - доступен для обоих операций. Направление обмена закодированы мнемоникой Data In для ввода данных из КВУ, Data Out - для вывода данных в КВУ, а Data i/o - для двунаправленного обмена.

### 2.2 Команды ввода-вывода

Команды ввода-вывода приведены на рисунке В.13. Указан формат команды, в котором код операции представлен значением 0x1 в разрядах с 12 по 15. В разрядах 8..11 располагается приказ на ввод-вывод, его три младших разряда декодируются аппаратно на дешифраторе приказов (DC 10), а биты с 0 по 7 кодируют адрес регистра контроллера ввода вывода, с которым осуществляется обмен. К командам добавлена операция возврата из прерывания IRET, которая осуществляет восстановление из стека значений регистра состояния и счетчика команд.

- Команда DI запрещает прерывания, помещая в 5 бит регистра состояния 'О'.
- Команда EI разрешает прерывания, помещая в 5 бит регистра состояния Т.
- Команда IN #reg осуществляет чтение из регистра ВУ по адресу в аккумулятор.
- Команда OUT  #reg осуществляет запись из аккумулятора по адресу в регистр ВУ.
- Команда INT #num вызывает программное прерывание с вектором num.
- Команда IRET возврат из программы обработки прерывания.

### 2.3 Программно-управляемый асинхронный обмен
При использовании программно-управляемого асинхронного обмена должна быть составлена программа, обеспечивающая пересылку данных из памяти ЭВМ в аккумулятор и далее в регистр памяти контроллера ВУ (вывод данных) или из регистра данных контроллера ВУ в аккумулятор и затем в память ЭВМ (ввод данных). Программа такого обмена строится так: сначала проверяется готовность ВУ к обмену и если оно готово, то дается команда на обмен. ВУ сообщает о готовности установкой флага в 6-м разряде регистре SR.

Пример. С помощью устройства ввода ВУ-2 (DR#4, SR#5) записать в ячейку в памяти коды символов слова "ДА" в кодировке K0I8-R. Пример программы представлен в табл. В.14.

В начале программа висит в ожидании готовности: считывается статусный (с номером 5) регистр ВУ-2, который передается через шину данных в 6 разряде числа, сравнивается с 0x40 (01000000г), и пока устройство не готово (SR равен 0). Такие циклы с неопределенным временем завершения, называются циклами “spin-loop”, они постоянно проверяет готовность устройства или переменной в программе, загружая процессор. Как только 6 разряд SR принимает значение 1 (устройство готово), в регистр данных ВУ считывается в младшие 8 разрядов аккумулятора, старшие разряды АС при этом остаются не изменными. Для того, чтобы подготовить АС к приему второго символа, происходит обмен байтов аккумулятора при помощи  команды swab, и сохранение этого символа в старших разрядах в ячейку результата. Далее снова происходит ожидание готовности устройства, после получения готовности загружается ячейка с результатом и считывается 2 символ в младшую часть аккумулятора. Готовое слово с двумя символами в аккумуляторе сохраняется в ячейку результата.

Необходимо еще раз подчеркнуть, что ввод-вывод происходит только с младшей частью аккумулятора, старшая часть во время выполнения команд in ли out не изменяется. Также важно, что при данной реализации асинхронного обмена ЭВМ тратит время на ожидание (неопределенно долгое!) момента готовности циклически опрашивая флаг (spin-loop) и не может выполнять никакой другой работы. Разумная организация процедур ввода-вывода позволяет избегать такого зацикливание, например через периодический опрос флага при выполнении основной программы или через прерывания.

### 2.4 Управляемый по прерыванию программы ввод-вывод
Этот вид обмена отличается от асинхронного тем, что сигнал готовности ВУ к обмену анализируется не программным, а аппаратным путем. ЭВМ может выполнять любую не связанную с обменом программу (будем называть ее основной).

Когда будет нажата кнопка готовности, то в случае, если в контроллере прерывания разрешены (наприме, реализуется через схему „И“ регистра состояния SR и старшего бита регистра управления MR, рис. В.11, контроллер КВУ-1) поступает сигнал "Запрос прерывания" по линии IntRq. После чего этот сигнал поступит на схему „И“ центрального процессра В.11 с 5 битом регистра состояния (EI - разрешение прерываний) проверяющий разрешены ли прерывания в ЭВМ и записывающий результат схемы в 6 бит регистра состояния (INT - прерывание). После цикла исполнения очередной инструкции основной программы в ЭВМ будет запущен комплекс программ, проверяющий, было ли требование прерывания, и если было, то формирует управляющий сигнал "Предоставление прерывания" IntSC, который последовательно проходит через все контроллеры (сигналы IntSCo - выходной и IntSCi - входной) и проверяет было ли в этом контроллере прерывание. Когда сигнал доходит до нужного контроллера, то он выставляет на шину адреса свой номер вектора прерывания (см. рис. В.15). После чего процессор по номеру прерывания вызывает программу обработки прерывания.

Ячейки памяти с адресами О-OxF отведены для инициализации векторов прерывания, по 2 ячейки на каждый вектор. В начале программы все контроллеры ВУ, в которых должны вызывать прерывания должны быть проинициализированы.

Если прерывания разрешены, то после выполнения всех команд кроме hit, а также если режим выполнения БЭВМ установлен в значение "РАБОТА", выполняются следующие действия:

- Шаг 1. По завершению цикла исполнения текущей команды происходит переход на цикл прерывания. Если в этот момент 6 бит регистра состояния INT (прерывание) не равен 1, то происходит переход к следующей команде. При наличии требования прерывания БЭВМ формирует сигнал "Предоставление прерывания" (IntSC) через выполнение микрокоманды ints.
- Шаг 2. Сохраняется счетчик команд и регистр состояния БЭВМ в стеке.
Шаг 3. Младшие 8 разрядов (номер вектора прерывания) записываются в буферный регистр и вычисляется адрес с переходом на подпрограмму обработки прерывания, как номер вектора * 2, после чего тот записывается в DR, а после в IP.
- Шаг 4. Далее к младшим 8 разрядам буферного регистра прибавляется 1, чтобы выбрать адрес следующей ячейки вектора прерывания (новый регистр состояния PS), ограничивая результат 8-ю разрядами. После чего по этому адресу содержимое в памяти записывается в DR, а после в PS.
- Шаг 5. Контроллер прерываний вновь переводится в состояние разрешение прерывания командой ei и осуществляется возврат к выполнению прерванной программы, т.е. к команде, адрес которой хранится в стеке, также восстанавливается сохраненный регистр состояния из стека.

   > Пример. Составить программу, которая постоянно наращивает на 1 содержимое аккумулятора. Восемь младших разрядов удвоенного значения аккумулятора должны выводиться на ВУ-1 по его запросу, а по запросу ВУ-3 содержимое регистра данных ВУ-3 должно записаться в ячейку 3F.

Если эту программу занести в память базовой ЭВМ, установить в СК пусковой адрес 20 и нажать кнопку ПУСК, то начнет выполняться бесконечный цикл наращивания содержимого аккумулятора. Когда же на пульте управления (рис В.11) будет нажата любая из кнопок готовности ВУ, то будет выполнен переход к подпрограмме обработки прерываний.

Для отладки программы (табл. В.8) в ней используются точки останова. Если в ячейке памяти точки останова расположена команда nop, то программа выполняется в обычном, не отладочном режиме. Если вместо nop поместить команду ньт, то программа во время выполнения остановится и будет возможно проконтролировать содержимое регистров и ячеек памяти. После завершения контроля необходимо продолжить дальнейшее исполнение программы. В приведенном примере точки останова позволяют исследовать содержимое аккумулятора в момент возникновения прерывания, а так же правильность подсчета и вывода на ВУ-3 удвоенного его значения.